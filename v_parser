import re

LABEL_MAP = {
    "Type of Inspection":        "type_of_inspection",
    "SAP Notification Number":   "sap_notification_number",
    "SAP Order #":               "sap_order_number",
    "Problem Statement":         "problem_statement",
    "Reported By":               "reported_by",
    "Reporter's Email":          "reporter_email",
    "Reporter's Contact Number": "reporter_contact_number",
    "Reporter's Full Name":      "reporter_full_name",
    "Type of Employee":          "employee_type",
    "Company Name":              "company_name",
    "Created At":                "created_at",
    "District Number":           "district_number",
    "High Fire":                 "high_fire",
    "How P1 was Identified":     "how_p1_identified",
    "CIP":                       "cip",
    "Address":                   "address",
    "Circuit Voltage":           "circuit_voltage",
    "Floc":                      "floc",
    "SFloc":                     "sfloc",
    "Circuit Name":              "circuit_name",
    "Longitude":                 "longitude",
    "Latitude":                  "latitude",
    "WorkOrderNumber":           "work_order_number",
    "Comments":                  "comments",
    "Photos":                    "photos_raw",
}

MAILTO_RE = re.compile(r"<mailto:[^>]+>")  # remove mailto tags

def clean_value(v: str) -> str:
    v = MAILTO_RE.sub("", v).strip()
    return v if v else None


def parse_p1_form_from_body(body: str) -> dict:
    """
    Handles:
    - label: value
    - label:\nvalue
    - multi-line Comments, Photos
    """
    result = {v: None for v in LABEL_MAP.values()}
    result["photo_urls"] = []

    # Only keep the form section
    header = "OVERHEAD DETAIL INSPECTION P1 FORM"
    idx = body.find(header)
    if idx != -1:
        body = body[idx + len(header):]

    lines = [ln.rstrip() for ln in body.splitlines()]

    current_key = None      # key we are filling (for continuation lines)
    waiting_for_value = None  # label that had no value on the same line

    for line in lines:
        stripped = line.strip()
        if not stripped:
            continue

        # Case: Label:
        if stripped.endswith(":") and stripped[:-1] in LABEL_MAP:
            waiting_for_value = LABEL_MAP[stripped[:-1]]
            current_key = waiting_for_value
            continue

        # Case: Label: value
        if ":" in stripped:
            label_raw, value_raw = stripped.split(":", 1)
            label = label_raw.strip().rstrip()
            value = clean_value(value_raw.strip())

            if label in LABEL_MAP:
                key = LABEL_MAP[label]
                result[key] = value
                current_key = key
                waiting_for_value = None
                continue

        # Case: value line when previous label had no inline value
        if waiting_for_value:
            result[waiting_for_value] = clean_value(stripped)
            waiting_for_value = None
            current_key = waiting_for_value
            continue

        # Otherwise, it's a continuation line (Comments or Photos)
        if current_key:
            existing = result[current_key] or ""
            result[current_key] = (existing + " " + stripped).strip()

    # Extract URLs from entire body
    urls = re.findall(r"https?://\S+", body)
    result["photo_urls"] = urls

    return result
